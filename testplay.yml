---
- hosts:
   - flocker

  tasks: 
  - name: creating the required directories for certificate creation
    file: path=/root/flockercerts/node state=directory mode=0755 recurse=yes


  - name: Creating Cluster, Control and Plugin certs
    command: chdir=/root/flockercerts/ {{ item }}
    with_items:
      - /root/flocker-client/bin/flocker-ca initialize flockercluster
      - /root/flocker-client/bin/flocker-ca create-control-certificate flocker.control
      - /root/flocker-client/bin/flocker-ca create-api-certificate plugin

  - name: Creating Cert and Keys for Node service
    command: /root/flocker-client/bin/flocker-ca create-node-certificate --outputpath=/root/flockercerts/node/ chdir=/root/flockercerts/

  - name: Renaming node cert files
    shell: chdir=/root/flockercerts/node/ {{ item }}
    with_items:
      - mv  *.key node.key
      - mv  *.crt node.crt

  - name: Transfer files from cli to local
    fetch:
       src: "{{ item }}"
       dest: /etc/ansible/flockercerts/
       flat: yes
    with_items:
       - /root/flockercerts/node/node.crt
       - /root/flockercerts/node/node.key
       - /root/flockercerts/cluster.crt
       - /root/flockercerts/cluster.key
       - /root/flockercerts/control-flocker.control.crt
       - /root/flockercerts/control-flocker.control.key
       - /root/flockercerts/plugin.crt
       - /root/flockercerts/plugin.key
