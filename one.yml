---
- hosts:
   - controlnode

  tasks: 
   - name: a for loop
     shell: mkdir /root/flockercerts/node/{{ item }} ; cd /root/flockercerts/ ; /root/flocker-client/bin/flocker-ca create-node-certificate --outputpath=/root/flockercerts/node/{{ item }} ; cd /root/flockercerts/node/{{ item }} ; mv *.crt node.crt ; mv *.key node.key
     with_items: "{{ groups['flockernode'] }}"

   - name: fetching node crt files
     fetch:
       src: /root/flockercerts/node/{{ item }}/node.crt
       dest: /etc/ansible/flockercerts/{{ item }}/
       flat: yes
     with_items: "{{ groups['flockernode'] }}"
   - name: fetching node key file
     fetch:
       src: /root/flockercerts/node/{{ item }}/node.key
       dest: /etc/ansible/flockercerts/{{ item }}/
       flat: yes
     with_items: "{{ groups['flockernode'] }}"

- hosts:
   - flockernode
  tasks:
   - name: copying node certs from local to agent    
     copy:
        src: /etc/ansible/flockercerts/{{ ansible_host }}/node.crt
        dest: /etc/flocker/  
   - name: copying node certs from local to agent
     copy:
        src: /etc/ansible/flockercerts/{{ ansible_host }}/node.key
        dest: /etc/flocker/
   - name: copying node certs from local to agent
     copy:
        src: /etc/ansible/flockercerts/plugin.crt
        dest: /etc/flocker/

   - name: copying node certs from local to agent
     copy:
        src: /etc/ansible/flockercerts/plugin.key
        dest: /etc/flocker/
   - name: copying node certs from local to agent
     copy:
        src: /etc/ansible/flockercerts/cluster.crt
        dest: /etc/flocker/
